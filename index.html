<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>EnergizeOS™ Project Documents (Secure, Portal UI)</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
  :root{
    --brand:#4da6ff; --brand-weak:#337fd1;
    --bg0:#0f1115; --bg1:#141821; --bg2:#1a2130; --card:#11161f;
    --line:#2a3241; --muted:#aab3c2; --text:#e8eef9; --ok:#22c55e; --warn:#f59e0b;
    --shadow:0 10px 30px rgba(0,0,0,.25);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,var(--bg0),var(--bg1));color:var(--text);font-family:Inter,system-ui,Arial,Helvetica,sans-serif}
  a{color:var(--brand);text-decoration:none}
  a:hover{color:#77beff}
  header{position:sticky;top:0;z-index:5;background:rgba(20,24,33,.9);backdrop-filter:saturate(130%) blur(6px);border-bottom:1px solid var(--line)}
  .bar{max-width:1200px;margin:0 auto;padding:14px 16px;display:flex;gap:10px;align-items:center;justify-content:space-between}
  .brand{font-weight:800;font-size:22px;letter-spacing:.4px}
  .tools{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .search{display:flex;gap:8px}
  input[type="search"], select{background:#0f141d;color:var(--text);border:1px solid var(--line);padding:.6rem .8rem;border-radius:10px;min-width:260px}
  select{min-width:180px}
  .btn{background:#0e1622;border:1px solid var(--line);color:var(--text);padding:.55rem .9rem;border-radius:10px;cursor:pointer}
  .btn:hover{border-color:#3a4b67;background:#122034}
  .pill{padding:.15rem .55rem;border:1px solid var(--line);border-radius:999px;font-size:.75rem;color:#c9d4e5}
  .pill.ok{border-color:#204c31;color:#9be7b0}
  .pill.warn{border-color:#5c4422;color:#ffd89b}
  .user{display:flex;align-items:center;gap:10px}
  .avatar{width:28px;height:28px;border-radius:50%;border:1px solid var(--line);box-shadow:var(--shadow);object-fit:cover}

  /* layout */
  .wrap{max-width:1200px;margin:18px auto;padding:0 16px;display:grid;grid-template-columns:320px 1fr;gap:16px}
  @media (max-width:960px){ .wrap{grid-template-columns:1fr} .sidebar{order:2} .content{order:1} }
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:var(--shadow)}

  /* sidebar tree */
  .tree-head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--line)}
  .tree{max-height:70vh;overflow:auto}
  .row{display:flex;align-items:center;gap:.55rem;padding:10px 12px;position:relative;cursor:pointer}
  .row:hover{background:#121a28}
  .row.active{background:#0f192a;border-left:2px solid var(--brand)}
  .toggle{width:22px;text-align:center;color:#9bb3d6}
  .name{font-weight:600}
  .meta{color:var(--muted);font-size:.85rem;margin-left:6px}
  .indent-0{padding-left:10px}
  .indent-1{padding-left:32px}
  .indent-2{padding-left:54px}
  .panel{display:none}
  .panel.open{display:block}
  .row::before{content:"";position:absolute;left:21px;top:0;bottom:0;border-left:1px dashed #2b3648}
  .indent-0::before{display:none}
  .hit{background:linear-gradient(transparent 60%, rgba(77,166,255,.25) 60%)}

  /* content (file grid) */
  .content-head{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--line)}
  .title{font-weight:800}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;padding:14px}
  @media (max-width:1200px){ .grid{grid-template-columns:repeat(2,1fr)} }
  @media (max-width:620px){ .grid{grid-template-columns:1fr} }
  .file{background:linear-gradient(180deg,#101827,#0d1421);border:1px solid var(--line);border-radius:12px;padding:12px;display:flex;gap:10px}
  .file i{font-size:22px;margin-top:2px;color:#c9d8f5}
  .f-body{flex:1}
  .f-name{font-weight:700;margin-bottom:6px;line-height:1.25}
  .f-meta{font-size:.85rem;color:#9fb0c8}
  .tags{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
  .tag{font-size:.72rem;padding:.1rem .45rem;border:1px solid var(--line);border-radius:999px}
  .tag.tech{border-color:#274b74;color:#9cc7ff}
  .tag.legal{border-color:#5c3e22;color:#ffd9a3}
  .tag.other{border-color:#3c485d;color:#cdd7e6}
  .f-actions{display:flex;gap:8px;align-items:center}
  .link-btn{background:#0f1723;border:1px solid var(--line);padding:.35rem .6rem;border-radius:8px;font-size:.85rem}
  .link-btn:hover{border-color:#3a4b67;background:#14233a}

  footer{border-top:1px solid var(--line);padding:18px;text-align:center;color:#9fb0c8}
  footer a{color:#9cc7ff}
</style>
</head>
<body>

<header>
  <div class="bar">
    <div class="brand">Project Documents</div>
    <div class="tools">
      <div class="search">
        <input id="q" type="search" placeholder="Search customers / projects / files"/>
        <select id="cat">
          <option value="all">All categories</option>
          <option value="tech">Technical Proposals</option>
          <option value="legal">Legal & Commercial</option>
          <option value="other">Other Attachments</option>
        </select>
      </div>
      <button id="expandAll" class="btn">Expand all</button>
      <button id="collapseAll" class="btn">Collapse all</button>
      <span id="stats" class="pill">Not signed in</span>
      <div class="user">
        <img id="avatar" class="avatar" src="" alt="" style="display:none"/>
        <span id="email" class="pill" style="display:none"></span>
        <button id="signin" class="btn">Sign in with Google</button>
        <button id="signout" class="btn" style="display:none">Sign out</button>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <aside class="sidebar card">
    <div class="tree-head">
      <div><i class="fa-solid fa-sitemap"></i> <b>Customers & Projects</b></div>
      <span id="treeCount" class="pill">0 / 0</span>
    </div>
    <div id="tree" class="tree"></div>
  </aside>

  <section class="content card">
    <div class="content-head">
      <div class="title"><i class="fa-regular fa-folder-open"></i> <span id="curTitle">Select a project</span></div>
      <div class="pill" id="curCount">0 files</div>
    </div>
    <div id="grid" class="grid"></div>
  </section>
</main>

<footer>
  © 2025 Energize Solutions Inc. – All rights reserved. |
  Powered by GitHub Pages |
  Contact: <a href="mailto:info@energizeos.com">info@energizeos.com</a>
</footer>

<!-- Google Identity Services -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script>
/* ======== CONFIG (pre-filled) ======== */
const CONFIG = {
  CLIENT_ID: '484304558800-7shgksndvt5psc0rllrk4boj5p5aaave.apps.googleusercontent.com',
  ROOT_FOLDER_ID: '1gQY05eoSW5WU1U4emQELF0uYiY6jpT7j',
  PAGE_SIZE: 200,
  SORT_CUSTOMERS: "name",
  SORT_PROJECTS: "name",
  SORT_FILES: "modifiedTime desc",
  EXPORT_GOOGLE_DOCS_AS: "pdf"
};
/* Categories */
const CATEGORY_MAP = {
  tech:  { label:'Technical Proposals', keywords:['spec','datasheet','technical','proposal','design','drawing'] },
  legal: { label:'Legal & Commercial',  keywords:['contract','agreement','terms','msa','quote','pricing','commercial','invoice'] }
};
const OTHER_KEY='other';

/* Elements */
const $q=document.getElementById('q'), $cat=document.getElementById('cat');
const $expandAll=document.getElementById('expandAll'), $collapseAll=document.getElementById('collapseAll');
const $stats=document.getElementById('stats'), $tree=document.getElementById('tree');
const $grid=document.getElementById('grid'), $curTitle=document.getElementById('curTitle'), $curCount=document.getElementById('curCount');
const $signin=document.getElementById('signin'), $signout=document.getElementById('signout');
const $email=document.getElementById('email'), $avatar=document.getElementById('avatar'), $treeCount=document.getElementById('treeCount');

/* State + persistence */
let ACCESS_TOKEN=null, tokenClient=null, USER=null;
const TOK_KEY='eos.token', EXP_KEY='eos.exp', EXPANDED='eos.tree.expanded', LAST_PROJECT='eos.last.project';
let TOTALS={customers:0,projects:0,files:0};
let MODEL={ customers:[] }; // {id,name, projects:[{id,name, files:[]}]}
function saveExpanded(set){ localStorage.setItem(EXPANDED, JSON.stringify([...set])); }
function loadExpanded(){ try{ return new Set(JSON.parse(localStorage.getItem(EXPANDED)||'[]')); }catch{ return new Set(); } }
let expanded=loadExpanded();
function saveLastProject(pid){ localStorage.setItem(LAST_PROJECT, pid||''); }
function loadLastProject(){ return localStorage.getItem(LAST_PROJECT)||''; }

function setToken(token,expiresIn=3500){
  ACCESS_TOKEN=token;
  const expAt=Date.now()+(expiresIn-60)*1000;
  localStorage.setItem(TOK_KEY,token); localStorage.setItem(EXP_KEY,String(expAt));
}
function readToken(){ const t=localStorage.getItem(TOK_KEY), e=+localStorage.getItem(EXP_KEY)||0; if(t&&Date.now()<e){ACCESS_TOKEN=t;return true} return false; }
function revoke(){ const t=localStorage.getItem(TOK_KEY); if(t) google.accounts.oauth2.revoke(t,()=>{}); localStorage.removeItem(TOK_KEY); localStorage.removeItem(EXP_KEY); ACCESS_TOKEN=null; }

function esc(s){return (s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));}
function bytes(n){if(!n||n<=0)return'';const u=['B','KB','MB','GB','TB'];const i=Math.floor(Math.log(n)/Math.log(1024));return (n/Math.pow(1024,i)).toFixed(1)+' '+u[i];}
function bucket(name){const n=(name||'').toLowerCase();for(const k of Object.keys(CATEGORY_MAP)){if(CATEGORY_MAP[k].keywords.some(w=>n.includes(w)))return k;}return OTHER_KEY;}
function hi(text, q){ if(!q) return esc(text); const r=new RegExp('('+q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')+')','ig'); return esc(text).replace(r,'<span class="hit">$1</span>'); }

/* OAuth (drive + basic profile) */
function initOAuth(){
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CONFIG.CLIENT_ID,
    scope: 'openid email profile https://www.googleapis.com/auth/drive.readonly',
    callback: async (resp)=>{
      if(resp?.access_token){ setToken(resp.access_token, resp.expires_in); await fetchUser(); afterSignIn(); }
      else $stats.textContent='Auth failed';
    }
  });
}
async function fetchUser(){
  try{
    const res=await fetch('https://www.googleapis.com/oauth2/v3/userinfo',{headers:{Authorization:`Bearer ${ACCESS_TOKEN}`}});
    if(res.ok){ USER=await res.json(); $email.textContent=USER.email||''; if(USER.email){$email.style.display='inline-block'}; if(USER.picture){$avatar.src=USER.picture; $avatar.style.display='inline-block';}}
  }catch{}
}
function afterSignIn(){ $stats.textContent='Signed in'; $signin.style.display='none'; $signout.style.display='inline-block'; render(); }

/* events */
window.addEventListener('DOMContentLoaded',()=>{
  $signin.addEventListener('click',()=>{ ensureInit(); tokenClient.requestAccessToken({prompt:'consent'}) });
  $signout.addEventListener('click',()=>{ revoke(); $signin.style.display='inline-block'; $signout.style.display='none'; $email.style.display='none'; $avatar.style.display='none'; $stats.textContent='Signed out'; $tree.innerHTML=''; $grid.innerHTML=''; $curTitle.textContent='Select a project'; $curCount.textContent='0 files'; });
  $q.addEventListener('input', debounce(applyFilters,120));
  $cat.addEventListener('change', applyFilters);
  $expandAll.addEventListener('click', ()=>{ document.querySelectorAll('.panel').forEach(p=>p.classList.add('open')); document.querySelectorAll('.row .toggle i').forEach(i=>{i.classList.remove('fa-caret-right'); i.classList.add('fa-caret-down');}); expanded=new Set(MODEL.customers.map(c=>c.id)); saveExpanded(expanded); });
  $collapseAll.addEventListener('click', ()=>{ document.querySelectorAll('.panel').forEach(p=>p.classList.remove('open')); document.querySelectorAll('.row .toggle i').forEach(i=>{i.classList.add('fa-caret-right'); i.classList.remove('fa-caret-down');}); expanded=new Set(); saveExpanded(expanded); });

  if(readToken()){ ensureInit(); fetchUser().then(afterSignIn); } else { silent(); }
});
function ensureInit(){ if(!tokenClient && window.google?.accounts?.oauth2) initOAuth(); }
function silent(){ ensureInit(); tokenClient.callback=(r)=>{ if(r?.access_token){ setToken(r.access_token,r.expires_in); fetchUser().then(afterSignIn); } }; tokenClient.requestAccessToken({prompt:''}); }
function debounce(fn,ms=250){ let t; return (...a)=>{clearTimeout(t); t=setTimeout(()=>fn(...a),ms)} }

/* Drive helpers */
async function driveList({q,orderBy}){
  const base='https://www.googleapis.com/drive/v3/files';
  const fields='nextPageToken, files(id,name,mimeType,modifiedTime,webViewLink,iconLink,size,exportLinks)';
  let token=null, out=[];
  do{
    const url=new URL(base);
    url.searchParams.set('fields',fields); url.searchParams.set('pageSize',CONFIG.PAGE_SIZE);
    if(orderBy) url.searchParams.set('orderBy', orderBy);
    if(q) url.searchParams.set('q', q);
    if(token) url.searchParams.set('pageToken', token);
    const res=await fetch(url,{headers:{Authorization:`Bearer ${ACCESS_TOKEN}`}});
    if(res.status===401||res.status===403) throw new Error('Not authorized for this Drive folder.');
    const data=await res.json(); out.push(...(data.files||[])); token=data.nextPageToken||null;
  }while(token);
  return out;
}
const qFolders = "mimeType = 'application/vnd.google-apps.folder' and trashed = false";
async function listCustomers(root){return driveList({q:`'${root}' in parents and ${qFolders}`, orderBy:CONFIG.SORT_CUSTOMERS});}
async function listProjects(pid){return driveList({q:`'${pid}' in parents and ${qFolders}`, orderBy:CONFIG.SORT_PROJECTS});}
async function listFiles(pid){return driveList({q:`'${pid}' in parents and mimeType != 'application/vnd.google-apps.folder' and trashed = false`, orderBy:CONFIG.SORT_FILES});}

function downloadLink(file){
  const mt=file.mimeType||'';
  const out={pdf:'application/pdf',docx:'application/vnd.openxmlformats-officedocument.wordprocessingml.document',xlsx:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',pptx:'application/vnd.openxmlformats-officedocument.presentationml.presentation'};
  if(mt.startsWith('application/vnd.google-apps')){
    if(file.exportLinks){
      const want=(CONFIG.EXPORT_GOOGLE_DOCS_AS||'pdf').toLowerCase();
      const target = mt.includes('spreadsheet') ? (want==='xlsx'?out.xlsx:out.pdf)
                  : mt.includes('presentation') ? (want==='pptx'?out.pptx:out.pdf)
                  : mt.includes('document')    ? (want==='docx'?out.docx:out.pdf)
                  : out.pdf;
      return file.exportLinks[target]||file.webViewLink;
    }
    return file.webViewLink;
  }
  return `https://www.googleapis.com/drive/v3/files/${file.id}?alt=media`;
}

/* Rendering */
function treeRow({level=0,id,name,meta='',open=false}){
  return `<div class="row indent-${level}" data-id="${id}" data-level="${level}">
    <span class="toggle"><i class="fa-solid ${open?'fa-caret-down':'fa-caret-right'}"></i></span>
    <i class="fa-${level===0?'solid':'regular'} fa-folder"></i>
    <span class="name">${esc(name)}</span>
    <span class="meta">${meta}</span>
  </div>
  <div class="panel ${open?'open':''}" data-parent="${id}"></div>`;
}
function fileCard(file, q){
  const tag=bucket(file.name);
  const dt=file.modifiedTime?new Date(file.modifiedTime).toLocaleDateString():'';
  const sz=file.size?bytes(+file.size):'';
  const dl=downloadLink(file);
  return `<div class="file">
    <i class="fa-regular fa-file-lines"></i>
    <div class="f-body">
      <div class="f-name">${hi(file.name,q)}</div>
      <div class="f-meta">${dt}${sz?` • ${sz}`:''}</div>
      <div class="tags"><span class="tag ${tag}">${tag}</span></div>
    </div>
    <div class="f-actions">
      <a class="link-btn" href="${file.webViewLink}" target="_blank" rel="noopener"><i class="fa-regular fa-eye"></i></a>
      <a class="link-btn" href="${dl}" target="_blank" rel="noopener"><i class="fa-solid fa-download"></i></a>
    </div>
  </div>`;
}

/* main render */
async function render(){
  $tree.innerHTML='<div style="padding:14px;color:#9fb0c8">Loading…</div>';
  TOTALS={customers:0,projects:0,files:0}; MODEL.customers=[];
  const customers=await listCustomers(CONFIG.ROOT_FOLDER_ID);
  TOTALS.customers=customers.length;

  // Build model
  for(const c of customers){
    const projects=await listProjects(c.id);
    TOTALS.projects+=projects.length;
    const projModels=[];
    for(const p of projects){
      const files=await listFiles(p.id);
      TOTALS.files+=files.length;
      projModels.push({id:p.id,name:p.name,files});
    }
    MODEL.customers.push({id:c.id,name:c.name,projects:projModels});
  }

  // render tree
  const html = MODEL.customers.map(c=>{
    const filesTotal=c.projects.reduce((s,p)=>s+p.files.length,0);
    return treeRow({level:0,id:c.id,name:c.name,meta:`<span class="pill">${c.projects.length} projects • ${filesTotal} files</span>`,open:expanded.has(c.id)});
  }).join('');
  $tree.innerHTML = html || '<div style="padding:14px;color:#9fb0c8">No customers found.</div>';
  $treeCount.textContent = `${TOTALS.customers} / ${TOTALS.projects}`;

  bindTree();
  $stats.textContent = `Customers: ${TOTALS.customers} • Projects: ${TOTALS.projects} • Files: ${TOTALS.files}`;

  // auto-open last project
  const last = loadLastProject();
  if(last){ const row = $tree.querySelector(`.row[data-id="${last}"]`); if(row){ selectProject(row); scrollIntoViewIfNeeded(row); } }
}

function bindTree(){
  // fill each customer panel with its projects
  MODEL.customers.forEach(c=>{
    const panel = $tree.querySelector(`.panel[data-parent="${c.id}"]`);
    if(!panel) return;
    panel.innerHTML = c.projects.map(p=>{
      return `<div class="row indent-1" data-id="${p.id}" data-level="1">
                <span class="toggle"><i class="fa-solid fa-circle-small" style="opacity:.0"></i></span>
                <i class="fa-regular fa-folder"></i>
                <span class="name">${esc(p.name)}</span>
                <span class="meta"><span class="pill">${p.files.length} files</span></span>
              </div>`;
    }).join('');
  });

  // toggle expand
  $tree.querySelectorAll('.row .toggle').forEach(t=>{
    const row=t.closest('.row'); const level=+row.dataset.level;
    if(level!==0) { t.style.visibility='hidden'; return; }
    const id=row.dataset.id; const panel=row.nextElementSibling;
    t.addEventListener('click', (e)=>{ e.stopPropagation(); const i=t.querySelector('i'); const open=!panel.classList.contains('open'); panel.classList.toggle('open', open); i.classList.toggle('fa-caret-right', !open); i.classList.toggle('fa-caret-down', open); if(open){expanded.add(id)} else {expanded.delete(id)}; saveExpanded(expanded); });
  });

  // click to select project
  $tree.querySelectorAll('.row').forEach(row=>{
    row.addEventListener('click', (e)=>{
      const level=+row.dataset.level;
      if(level===0){ // clicking customer label toggles
        row.querySelector('.toggle').click();
      }else if(level===1){
        selectProject(row);
      }
    });
  });
}

function selectProject(row){
  $tree.querySelectorAll('.row').forEach(r=>r.classList.remove('active'));
  row.classList.add('active');
  const pid=row.dataset.id;
  const cust = MODEL.customers.find(c=> c.projects.some(p=>p.id===pid));
  const proj = cust?.projects.find(p=>p.id===pid);
  if(!proj) return;
  $curTitle.textContent = `${cust.name} / ${proj.name}`;
  const q=($q.value||'').trim().toLowerCase();
  const cat=$cat.value;
  const files = proj.files.filter(f=>{
    const name=(f.name||'').toLowerCase();
    const inCat = (cat==='all') || (bucket(f.name)===cat);
    const inQ   = !q || name.includes(q) || cust.name.toLowerCase().includes(q) || proj.name.toLowerCase().includes(q);
    return inCat && inQ;
  });
  $grid.innerHTML = files.length ? files.map(f=>fileCard(f, q)).join('') : `<div style="padding:16px;color:#9fb0c8">No files matched.</div>`;
  $curCount.textContent = `${files.length} file${files.length===1?'':'s'}`;
  saveLastProject(pid);
}

function applyFilters(){
  const active = $tree.querySelector('.row.active');
  if(active){ selectProject(active); }
  // highlight matches in tree
  const q=($q.value||'').trim().toLowerCase();
  $tree.querySelectorAll('.row .name').forEach(el=>{
    const text = el.textContent||'';
    el.innerHTML = hi(text, q);
  });
}

function scrollIntoViewIfNeeded(el){ const c=el.getBoundingClientRect(); if(c.top<120||c.bottom>window.innerHeight) el.scrollIntoView({block:'center'}); }
</script>
</body>
</html>