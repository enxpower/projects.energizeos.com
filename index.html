<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>EnergizeOSâ„¢ Project Documents</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<style>
  :root { --w:82%; }
  body{ background:#111; color:#fff; font-family:Arial, sans-serif; margin:0; padding:0; text-align:center; }
  h1{ padding:1rem 1rem .5rem; margin:0; }
  .toolbar{ width:var(--w); margin:0 auto 10px; display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; justify-content:space-between; }
  .toolbar .left, .toolbar .right{ display:flex; gap:.5rem; flex-wrap:wrap; }
  input[type="search"], select{ background:#1b1b1b; color:#eee; border:1px solid #333; padding:.6rem .75rem; border-radius:6px; min-width:220px; }
  .counter{ color:#aaa; font-size:.9rem; padding:.25rem .5rem; }
  .accordion{ background:#222; color:#fff; cursor:pointer; padding:16px; width:var(--w); margin:0 auto; border:none; text-align:left; font-size:16px; transition:.25s; border-bottom:1px solid #444; }
  .accordion:hover,.accordion.active{ background:#313131; }
  .panel{ display:none; background:#1a1a1a; overflow:hidden; text-align:left; width:var(--w); margin:0 auto 1rem; }
  .section{ padding:0 0 10px; }
  .section h3{ margin:0; padding:12px 16px 4px; color:#cfcfcf; font-size:1rem; }
  .file-link{ color:#4da6ff; text-decoration:none; display:block; padding:10px 18px; background:#1a1a1a; border-bottom:1px solid #2c2c2c; transition:background .2s; }
  .file-link:hover{ background:#262626; }
  .muted{ color:#9d9d9d; font-size:.9rem; padding:0 18px 10px; display:block; }
  .badge{ display:inline-block; border:1px solid #3b3b3b; padding:1px 6px; border-radius:999px; font-size:.75rem; color:#bbb; margin-left:6px; }
  .hidden{ display:none !important; }
  footer{ border-top:1px solid #444; margin-top:2rem; padding:1rem; font-size:.8rem; background:#111; }
  footer a{ color:#4da6ff; text-decoration:none; }
  .footer-icons a{ margin:0 10px; color:#ccc; font-size:1.2rem; }
</style>
</head>
<body>
  <h1>Project Documents</h1>
  <div class="toolbar">
    <div class="left">
      <input id="q" type="search" placeholder="Search customers / projects / files"/>
      <select id="cat">
        <option value="all">All categories</option>
        <option value="tech">Technical Proposals</option>
        <option value="legal">Legal & Commercial</option>
        <option value="other">Other Attachments</option>
      </select>
    </div>
    <div class="right">
      <span class="counter" id="stats">Loadingâ€¦</span>
    </div>
  </div>

  <div id="root">Loading customersâ€¦</div>

  <footer>
    <p>Â© 2025 Energize Solutions Inc. â€“ All rights reserved.<br/>
       Powered by GitHub Pages | Contact: <a href="mailto:info@energizeos.com">info@energizeos.com</a></p>
    <div class="footer-icons">
      <a href="https://www.linkedin.com/in/gongtiejing" target="_blank" aria-label="LinkedIn"><i class="fab fa-linkedin"></i></a>
      <a href="https://github.com/enxpower" target="_blank" aria-label="GitHub"><i class="fab fa-github"></i></a>
    </div>
  </footer>

<script>
/** ================== åŸºæœ¬é…ç½®ï¼ˆå®æ—¶ï¼Œæ— ç¼“å­˜ï¼‰ ================== */
const CONFIG = {
  API_KEY: 'AIzaSyCYWO2tmoIRNVwepHqGXY4cI5FM9MUJeHs',
  ROOT_FOLDER_ID: '1gQY05eoSW5WU1U4emQELF0uYiY6jpT7j', // projects/ çš„ Folder ID
  PAGE_SIZE: 200,
  SORT_CUSTOMERS: "name",            // or "modifiedTime desc"
  SORT_PROJECTS: "name",
  SORT_FILES: "modifiedTime desc",
  EXPORT_GOOGLE_DOCS_AS: "pdf"       // pdf / docx / xlsx / pptx
};

/** =============== åˆ†ç±»å…³é”®å­—ï¼ˆå¯è‡ªè¡Œå¢åˆ ï¼‰ =============== */
const CATEGORY_MAP = {
  tech:  { label:'ğŸ“ Technical Proposals', keywords:['spec','datasheet','technical','proposal','design','drawing'] },
  legal: { label:'ğŸ“ Legal and Commercial Documents', keywords:['contract','agreement','terms','msa','quote','pricing','commercial','invoice'] }
};
const OTHER_KEY = 'other';
const OTHER_LABEL = 'ğŸ“ Other Attachments';

/** =============== é€‰æ‹©å™¨ & ç»Ÿè®¡ =============== */
const $root = document.getElementById('root');
const $q = document.getElementById('q');
const $cat = document.getElementById('cat');
const $stats = document.getElementById('stats');
let TOTALS = { customers:0, projects:0, files:0 };

/* ================= Drive é€šç”¨åˆ†é¡µï¼ˆæ¯æ¬¡å®æ—¶è¯·æ±‚ï¼‰ ================= */
async function driveList({q, orderBy}) {
  const base = 'https://www.googleapis.com/drive/v3/files';
  const fields = 'nextPageToken, files(id,name,mimeType,modifiedTime,webViewLink,iconLink,size,exportLinks)';
  let pageToken = null;
  const out = [];
  do {
    const url = new URL(base);
    url.searchParams.set('key', CONFIG.API_KEY);
    url.searchParams.set('fields', fields);
    url.searchParams.set('pageSize', CONFIG.PAGE_SIZE);
    if (orderBy) url.searchParams.set('orderBy', orderBy);
    if (q) url.searchParams.set('q', q);
    if (pageToken) url.searchParams.set('pageToken', pageToken);

    const res = await fetch(url.href);
    const data = await res.json();
    if (data.files) out.push(...data.files);
    pageToken = data.nextPageToken || null;
  } while (pageToken);
  return out;
}

/* ================ åˆ—å®¢æˆ·ï¼ˆå­æ–‡ä»¶å¤¹ï¼‰ ================ */
async function listCustomers(rootId) {
  const q = [
    `'${rootId}' in parents`,
    "mimeType = 'application/vnd.google-apps.folder'",
    "trashed = false"
  ].join(' and ');
  return await driveList({ q, orderBy: CONFIG.SORT_CUSTOMERS });
}

/* ================ åˆ—é¡¹ç›®ï¼ˆå®¢æˆ·ä¸‹å­æ–‡ä»¶å¤¹ï¼‰ ================ */
async function listProjects(customerFolderId) {
  const q = [
    `'${customerFolderId}' in parents`,
    "mimeType = 'application/vnd.google-apps.folder'",
    "trashed = false"
  ].join(' and ');
  return await driveList({ q, orderBy: CONFIG.SORT_PROJECTS });
}

/* ================ åˆ—æ–‡ä»¶ï¼ˆé¡¹ç›®ä¸‹æ–‡ä»¶ï¼‰ ================ */
async function listFiles(projectFolderId) {
  const q = [
    `'${projectFolderId}' in parents`,
    "mimeType != 'application/vnd.google-apps.folder'",
    "trashed = false"
  ].join(' and ');
  return await driveList({ q, orderBy: CONFIG.SORT_FILES });
}

/* ================ ç”Ÿæˆä¸‹è½½é“¾æ¥ï¼ˆå« Google æ–‡æ¡£å¯¼å‡ºï¼‰ ================ */
function getDownloadLink(file) {
  const mt = file.mimeType || '';
  const mimeOut = {
    pdf:  'application/pdf',
    docx: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
    xlsx: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
    pptx: 'application/vnd.openxmlformats-officedocument.presentationml.presentation'
  };
  if (mt.startsWith('application/vnd.google-apps')) {
    if (file.exportLinks) {
      const want = (CONFIG.EXPORT_GOOGLE_DOCS_AS || 'pdf').toLowerCase();
      const target =
        mt.includes('spreadsheet') ? (want==='xlsx' ? mimeOut.xlsx : mimeOut.pdf) :
        mt.includes('presentation')? (want==='pptx' ? mimeOut.pptx: mimeOut.pdf) :
        mt.includes('document')   ? (want==='docx' ? mimeOut.docx: mimeOut.pdf) :
        mimeOut.pdf;
      const url = file.exportLinks[target] || file.webViewLink;
      return url + `&key=${CONFIG.API_KEY}`;
    }
    return file.webViewLink;
  }
  return `https://www.googleapis.com/drive/v3/files/${file.id}?alt=media&key=${CONFIG.API_KEY}`;
}

/* ================= å·¥å…· ================= */
function esc(s){ return (s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }
function bytes(n){ if(!n||n<=0) return ''; const u=['B','KB','MB','GB','TB']; const i=Math.floor(Math.log(n)/Math.log(1024)); return (n/Math.pow(1024,i)).toFixed(1)+' '+u[i]; }
function bucketCategory(name){
  const n = (name||'').toLowerCase();
  for (const key of Object.keys(CATEGORY_MAP)) {
    if (CATEGORY_MAP[key].keywords.some(k => n.includes(k))) return key;
  }
  return OTHER_KEY;
}
function updateStatsText(curC, curP, curF){
  $stats.textContent = `Customers: ${curC}/${TOTALS.customers} Â· Projects: ${curP}/${TOTALS.projects} Â· Files: ${curF}/${TOTALS.files}`;
}

/* ================== æ¸²æŸ“ ================== */
function fileRow(file) {
  const dl = getDownloadLink(file);
  const sz = file.size ? ` <small>(${bytes(+file.size)})</small>` : '';
  const dt = file.modifiedTime ? ` <small>Â· ${new Date(file.modifiedTime).toLocaleDateString()}</small>` : '';
  const catKey = bucketCategory(file.name);
  return `<a class="file-link" data-cat="${catKey}" data-name="${esc(file.name.toLowerCase())}"
            href="${dl}" target="_blank" rel="noopener">
            ğŸ“„ ${esc(file.name)}${sz}${dt}
          </a>`;
}

function projectBlock(projectName, files) {
  const buckets = { tech:[], legal:[], other:[] };
  files.forEach(f => buckets[bucketCategory(f.name)].push(f));

  let html = `<button class="accordion" data-type="project" data-name="${esc(projectName.toLowerCase())}">
                ${esc(projectName)} <span class="badge">${files.length}</span>
              </button>
              <div class="panel">`;

  const order = ['tech','legal','other'];
  order.forEach(key=>{
    const label = key===OTHER_KEY ? OTHER_LABEL : CATEGORY_MAP[key].label;
    html += `<div class="section"><h3>${label}</h3>`;
    html += buckets[key].length ? buckets[key].map(fileRow).join('') : `<span class="muted">No files</span>`;
    html += `</div>`;
  });

  html += `</div>`;
  return html;
}

function customerBlock(customerName, projectsHTML, projectCount, fileCount) {
  return `<button class="accordion" data-type="customer" data-name="${esc(customerName.toLowerCase())}">
            ${esc(customerName)} <span class="badge">${projectCount} projects Â· ${fileCount} files</span>
          </button>
          <div class="panel">
            ${projectsHTML}
          </div>`;
}

function bindAccordion(rootEl){
  const acc = rootEl.querySelectorAll('.accordion');
  acc.forEach(btn=>{
    btn.addEventListener('click', function(){
      this.classList.toggle('active');
      const panel = this.nextElementSibling;
      panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
    });
  });
}

/* ================== æœç´¢ä¸ç­›é€‰ï¼ˆå®¢æˆ·/é¡¹ç›®/æ–‡ä»¶ ä¸‰çº§ï¼‰ ================== */
function applyFilters(){
  const q = ($q.value || '').trim().toLowerCase();
  const cat = $cat.value; // all / tech / legal / other

  const customerBtns = $root.querySelectorAll('.accordion[data-type="customer"]');
  let visC = 0, visP = 0, visF = 0;

  customerBtns.forEach(cbtn=>{
    const cPanel = cbtn.nextElementSibling;

    const projectBtns = cPanel.querySelectorAll('.accordion[data-type="project"]');
    let showCustomer = false;

    projectBtns.forEach(pbtn=>{
      const pPanel = pbtn.nextElementSibling;

      const files = pPanel.querySelectorAll('.file-link');
      let matchFiles = 0;
      files.forEach(a=>{
        const name = a.dataset.name || '';
        const inCat = (cat==='all') || (a.dataset.cat===cat);
        const inQ = !q || name.includes(q) || pbtn.dataset.name.includes(q) || cbtn.dataset.name.includes(q);
        const keep = inCat && inQ;
        a.classList.toggle('hidden', !keep);
        if (keep) matchFiles++;
      });

      const keepProject = matchFiles>0 || (!q || pbtn.dataset.name.includes(q) || cbtn.dataset.name.includes(q));
      pbtn.classList.toggle('hidden', !keepProject);
      pPanel.classList.toggle('hidden', !keepProject);

      if (keepProject) {
        showCustomer = true;
        visP++;
        visF += matchFiles;
      }
    });

    cbtn.classList.toggle('hidden', !showCustomer);
    cPanel.classList.toggle('hidden', !showCustomer);
    if (showCustomer) visC++;
  });

  updateStatsText(visC, visP, visF);
}

/* ç®€å•é˜²æŠ– */
function debounce(fn, ms=250){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); }; }

/* ================== ä¸»æµç¨‹ï¼ˆå®æ—¶ï¼‰ ================== */
async function render() {
  $root.textContent = 'Loading customersâ€¦';
  TOTALS = { customers:0, projects:0, files:0 };

  const customers = await listCustomers(CONFIG.ROOT_FOLDER_ID);
  TOTALS.customers = customers.length;

  const customerBlocks = await Promise.all(customers.map(async (c)=>{
    const projects = await listProjects(c.id);
    let filesTotal = 0;
    TOTALS.projects += projects.length;

    const projectsHTML = await Promise.all(projects.map(async (p)=>{
      const files = await listFiles(p.id);
      filesTotal += files.length;
      TOTALS.files += files.length;
      return projectBlock(p.name, files);
    }));

    return customerBlock(c.name, projectsHTML.join(''), projects.length, filesTotal);
  }));

  const html = customerBlocks.join('');
  $root.innerHTML = html || '<p>No customers/projects found.</p>';
  updateStatsText(TOTALS.customers, TOTALS.projects, TOTALS.files);
  bindAccordion($root);
}

$q.addEventListener('input', debounce(applyFilters, 150));
$cat.addEventListener('change', applyFilters);

render(); // æ¯æ¬¡è®¿é—®æˆ–åˆ·æ–°éƒ½ä¼šå®æ—¶è¯·æ±‚ Drive
</script>
</body>
</html>
