<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>EnergizeOS‚Ñ¢ Project Documents (Secure)</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
  :root { --w:82%; --line:#333; --bg:#111; --card:#1a1a1a; --hover:#242424; }
  body{ background:var(--bg); color:#fff; font-family:Arial, sans-serif; margin:0; padding:0; }
  h1{ text-align:center; margin:0; padding:22px 12px 10px; }
  .toolbar{ width:var(--w); margin:0 auto 10px; display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; justify-content:space-between; }
  .toolbar .left, .toolbar .right{ display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; }
  input[type="search"], select{ background:#1b1b1b; color:#eee; border:1px solid #333; padding:.6rem .75rem; border-radius:8px; min-width:220px; }
  .btn{ background:#2a2a2a; color:#eee; border:1px solid #3a3a3a; padding:.55rem .9rem; border-radius:8px; cursor:pointer; }
  .btn:hover{ background:#343434; }
  .counter{ color:#aaa; font-size:.9rem; }
  #root{ width:var(--w); margin:0 auto 18px; }
  .tree{ background:var(--card); border:1px solid var(--line); border-radius:10px; overflow:hidden; }
  .row{ display:flex; align-items:center; gap:.6rem; padding:10px 14px; position:relative; }
  .row:hover{ background:var(--hover); }
  .row .toggle{ width:24px; text-align:center; cursor:pointer; color:#bbb; }
  .row .toggle.invisible{ visibility:hidden; }
  .label{ font-weight:600; }
  .meta{ color:#aaa; font-size:.85rem; margin-left:.5rem; }
  .indent-1{ padding-left:38px; }
  .indent-2{ padding-left:62px; }
  .indent-3{ padding-left:84px; }
  /* tree lines */
  .row::before{ content:""; position:absolute; left:22px; top:0; bottom:0; border-left:1px dashed var(--line); }
  .indent-1::before{ left:22px; }
  .indent-2::before{ left:46px; }
  .indent-3::before{ left:68px; }
  .root::before{ display:none; }
  .section{ padding:2px 0 12px 0; }
  .section h3{ margin:6px 0 6px 62px; color:#d2d2d2; font-size:1rem; }
  .file-link{ color:#4da6ff; text-decoration:none; display:block; padding:8px 14px; margin:0 8px 0 84px; border-left:2px solid #2c2c2c; }
  .file-link:hover{ background:#202020; }
  .badge{ display:inline-block; border:1px solid #3b3b3b; padding:1px 6px; border-radius:999px; font-size:.75rem; color:#bbb; margin-left:8px; }
  .muted{ color:#9d9d9d; font-size:.95rem; padding:10px 0 18px; text-align:center; }
  .hidden{ display:none !important; }

  footer{ border-top:1px solid #444; padding:16px; text-align:center; font-size:.85rem; }
  footer a{ color:#4da6ff; text-decoration:none; }
  .footer-icons a{ margin:0 10px; color:#ccc; font-size:1.2rem; }
</style>
</head>
<body>
  <h1>Project Documents</h1>

  <div class="toolbar">
    <div class="left">
      <input id="q" type="search" placeholder="Search customers / projects / files" />
      <select id="cat">
        <option value="all">All categories</option>
        <option value="tech">Technical Proposals</option>
        <option value="legal">Legal & Commercial</option>
        <option value="other">Other Attachments</option>
      </select>
      <button id="expandAll" class="btn">Expand all</button>
      <button id="collapseAll" class="btn">Collapse all</button>
    </div>
    <div class="right">
      <span class="counter" id="stats">Not signed in</span>
      <button id="signin" class="btn">Sign in with Google</button>
      <button id="signout" class="btn hidden">Sign out</button>
    </div>
  </div>

  <div id="root"></div>

  <footer>
    <p>¬© 2025 Energize Solutions Inc. ‚Äì All rights reserved.<br/>
       Powered by GitHub Pages | Contact: <a href="mailto:info@energizeos.com">info@energizeos.com</a></p>
    <div class="footer-icons">
      <a href="https://www.linkedin.com/in/gongtiejing" target="_blank" aria-label="LinkedIn"><i class="fab fa-linkedin"></i></a>
      <a href="https://github.com/enxpower" target="_blank" aria-label="GitHub"><i class="fab fa-github"></i></a>
    </div>
  </footer>

<!-- Google Identity Services -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script>
/** ================== CONFIG ================== */
const CONFIG = {
  CLIENT_ID: '484304558800-7shgksndvt5psc0rllrk4boj5p5aaave.apps.googleusercontent.com',
  ROOT_FOLDER_ID: '1gQY05eoSW5WU1U4emQELF0uYiY6jpT7j',
  PAGE_SIZE: 200,
  SORT_CUSTOMERS: "name",
  SORT_PROJECTS: "name",
  SORT_FILES: "modifiedTime desc",
  EXPORT_GOOGLE_DOCS_AS: "pdf" // pdf / docx / xlsx / pptx
};

/** =============== Categories =============== */
const CATEGORY_MAP = {
  tech:  { label:'üìÅ Technical Proposals', keywords:['spec','datasheet','technical','proposal','design','drawing'] },
  legal: { label:'üìÅ Legal & Commercial Documents', keywords:['contract','agreement','terms','msa','quote','pricing','commercial','invoice'] }
};
const OTHER_KEY = 'other';
const OTHER_LABEL = 'üìÅ Other Attachments';

/** =============== Elements & State =============== */
const $root = document.getElementById('root');
const $q = document.getElementById('q');
const $cat = document.getElementById('cat');
const $stats = document.getElementById('stats');
const $signin = document.getElementById('signin');
const $signout = document.getElementById('signout');
const $expandAll = document.getElementById('expandAll');
const $collapseAll = document.getElementById('collapseAll');

let ACCESS_TOKEN = null;
let TOTALS = { customers:0, projects:0, files:0 };

/** =============== OAuth with silent persistence =============== */
const TOK_KEY = 'eos.drive.token';
const EXP_KEY = 'eos.drive.exp';

let tokenClient = null;
function initOAuth() {
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CONFIG.CLIENT_ID,
    scope: 'https://www.googleapis.com/auth/drive.readonly',
    callback: (resp) => {
      if (resp && resp.access_token) {
        setToken(resp.access_token, resp.expires_in);
        afterSignIn();
      } else {
        showError('Failed to obtain access token.');
      }
    }
  });
}

function setToken(token, expiresInSec=3500){
  ACCESS_TOKEN = token;
  const expAt = Date.now() + (expiresInSec-60)*1000; // ÊèêÂâç1ÂàÜÈíüÂà∑Êñ∞
  localStorage.setItem(TOK_KEY, token);
  localStorage.setItem(EXP_KEY, String(expAt));
}
function readTokenFromStorage(){
  const t = localStorage.getItem(TOK_KEY);
  const e = Number(localStorage.getItem(EXP_KEY) || 0);
  if (t && e && Date.now() < e) {
    ACCESS_TOKEN = t;
    return true;
  }
  return false;
}
function needRefreshSoon(){
  const e = Number(localStorage.getItem(EXP_KEY) || 0);
  return !e || Date.now() > (e - 90*1000);
}
function revokeToken(){
  const t = localStorage.getItem(TOK_KEY);
  if (t) google.accounts.oauth2.revoke(t, ()=>{});
  localStorage.removeItem(TOK_KEY);
  localStorage.removeItem(EXP_KEY);
  ACCESS_TOKEN = null;
}

function afterSignIn(){
  $stats.textContent = 'Signed in';
  $signin.classList.add('hidden');
  $signout.classList.remove('hidden');
  render().catch(showError);
}

/* È°µÈù¢Âä†ËΩΩÔºö‰ºòÂÖà‰ΩøÁî®Áé∞ÊúâtokenÔºõÈúÄË¶ÅÊó∂ÈùôÈªòÁª≠Á≠æÔºà‰∏ç‰ºöÂºπÁ™óÔºâ */
window.addEventListener('DOMContentLoaded', () => {
  // ‰∫ã‰ª∂
  $signin.setAttribute('type','button');
  $signin.addEventListener('click', () => {
    ensureInit();
    if (!tokenClient) return showError('Google Identity script not ready.');
    tokenClient.requestAccessToken({ prompt: 'consent' });
  });
  $signout.addEventListener('click', () => {
    revokeToken();
    $signin.classList.remove('hidden'); $signout.classList.add('hidden');
    $stats.textContent = 'Signed out';
    $root.innerHTML = '';
  });
  $q.addEventListener('input', debounce(applyFilters, 150));
  $cat.addEventListener('change', applyFilters);
  $expandAll.addEventListener('click', expandAll);
  $collapseAll.addEventListener('click', collapseAll);

  // Â∞ùËØïËØªÂèñÁºìÂ≠òtoken
  if (readTokenFromStorage()) {
    $signin.classList.add('hidden'); $signout.classList.remove('hidden');
    $stats.textContent = 'Signed in';
    render().catch(showError);
    // ËÉåÊôØÈùôÈªòÁª≠Á≠æ
    if (needRefreshSoon()) silentRefresh();
  } else {
    // Êó†ÊúâÊïàtokenÔºåÂ∞ùËØïÈùôÈªòËé∑ÂèñÔºà‰∏çÂºπÁ™óÔºâ
    silentRefresh(true);
  }
});

function ensureInit(){ if (!tokenClient && window.google?.accounts?.oauth2) initOAuth(); }
function silentRefresh(firstLoad=false){
  ensureInit();
  if (!tokenClient) return;
  tokenClient.callback = (resp) => {
    if (resp?.access_token) {
      setToken(resp.access_token, resp.expires_in);
      afterSignIn();
    } else if (firstLoad) {
      $root.innerHTML = '<p class="muted">Please sign in to view documents.</p>';
    }
  };
  // prompt: '' Ë°®Á§∫ÈùôÈªòÔºå‰∏çÊâìÊñ≠Áî®Êà∑
  tokenClient.requestAccessToken({ prompt: '' });
}

/** =============== Drive helpers (Bearer token) =============== */
async function driveList({ q, orderBy }) {
  if (!ACCESS_TOKEN) throw new Error('Not signed in');
  const base = 'https://www.googleapis.com/drive/v3/files';
  const fields = 'nextPageToken, files(id,name,mimeType,modifiedTime,webViewLink,iconLink,size,exportLinks)';
  let pageToken = null;
  const out = [];
  do {
    const url = new URL(base);
    url.searchParams.set('fields', fields);
    url.searchParams.set('pageSize', CONFIG.PAGE_SIZE);
    if (orderBy) url.searchParams.set('orderBy', orderBy);
    if (q) url.searchParams.set('q', q);
    if (pageToken) url.searchParams.set('pageToken', pageToken);

    const res = await fetch(url.href, { headers: { Authorization: `Bearer ${ACCESS_TOKEN}` }});
    if (res.status === 401 || res.status === 403) throw new Error('Not authorized. Ensure this account has Drive access.');
    const data = await res.json();
    if (data.files) out.push(...data.files);
    pageToken = data.nextPageToken || null;
  } while (pageToken);
  return out;
}

async function listCustomers(rootId) {
  const q = [`'${rootId}' in parents`, "mimeType = 'application/vnd.google-apps.folder'", "trashed = false"].join(' and ');
  return await driveList({ q, orderBy: CONFIG.SORT_CUSTOMERS });
}
async function listProjects(customerFolderId) {
  const q = [`'${customerFolderId}' in parents`, "mimeType = 'application/vnd.google-apps.folder'", "trashed = false"].join(' and ');
  return await driveList({ q, orderBy: CONFIG.SORT_PROJECTS });
}
async function listFiles(projectFolderId) {
  const q = [`'${projectFolderId}' in parents`, "mimeType != 'application/vnd.google-apps.folder'", "trashed = false"].join(' and ');
  return await driveList({ q, orderBy: CONFIG.SORT_FILES });
}

function getDownloadLink(file) {
  const mt = file.mimeType || '';
  const mimeOut = {
    pdf:  'application/pdf',
    docx: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
    xlsx: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
    pptx: 'application/vnd.openxmlformats-officedocument.presentationml.presentation'
  };
  if (mt.startsWith('application/vnd.google-apps')) {
    if (file.exportLinks) {
      const want = (CONFIG.EXPORT_GOOGLE_DOCS_AS || 'pdf').toLowerCase();
      const target =
        mt.includes('spreadsheet') ? (want==='xlsx' ? mimeOut.xlsx : mimeOut.pdf) :
        mt.includes('presentation')? (want==='pptx' ? mimeOut.pptx: mimeOut.pdf) :
        mt.includes('document')   ? (want==='docx' ? mimeOut.docx: mimeOut.pdf) :
        mimeOut.pdf;
      return file.exportLinks[target] || file.webViewLink;
    }
    return file.webViewLink;
  }
  return `https://www.googleapis.com/drive/v3/files/${file.id}?alt=media`;
}

/** =============== Utils =============== */
function esc(s){
  return (s||'').replace(/[&<>"']/g, m => (
    {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]
  ));
}
function bytes(n){ if(!n||n<=0) return ''; const u=['B','KB','MB','GB','TB']; const i=Math.floor(Math.log(n)/Math.log(1024)); return (n/Math.pow(1024,i)).toFixed(1)+' '+u[i]; }
function bucketCategory(name){
  const n=(name||'').toLowerCase();
  for(const key of Object.keys(CATEGORY_MAP)){ if (CATEGORY_MAP[key].keywords.some(k => n.includes(k))) return key; }
  return OTHER_KEY;
}
function showError(err){ console.error(err); $root.innerHTML = `<p class="muted">Error: ${esc(String(err.message||err))}</p>`; $stats.textContent='Error'; }

/** =============== Rendering (tree) =============== */
function rowHTML(level, icon, title, meta='', hasToggle=false, open=false){
  const indent = `indent-${level}`;
  const tog = hasToggle ? `<span class="toggle"><i class="fa-solid ${open?'fa-caret-down':'fa-caret-right'}"></i></span>` : `<span class="toggle invisible"><i class="fa-solid fa-caret-right"></i></span>`;
  const ico = `<i class="fa-${icon}"></i>`;
  return `<div class="row ${indent} ${level===0?'root':''}" data-level="${level}">
            ${tog}<span class="label">${ico}&nbsp; ${esc(title)}</span><span class="meta">${meta}</span>
          </div>`;
}

function sectionHTML(label){ return `<div class="section"><h3><i class="fa-regular fa-folder-open"></i> ${label}</h3>`; }

function fileRow(file){
  const dl = getDownloadLink(file);
  const sz = file.size ? ` (${bytes(+file.size)})` : '';
  const dt = file.modifiedTime ? ` ¬∑ ${new Date(file.modifiedTime).toLocaleDateString()}` : '';
  const catKey = bucketCategory(file.name);
  return `<a class="file-link" data-cat="${catKey}" data-name="${esc(file.name.toLowerCase())}"
            href="${dl}" target="_blank" rel="noopener">
            <i class="fa-regular fa-file"></i> ${esc(file.name)}<small>${sz}${dt}</small>
          </a>`;
}

function projectBlock(projectName, files){
  const buckets = { tech:[], legal:[], other:[] };
  files.forEach(f => buckets[bucketCategory(f.name)].push(f));
  let html = rowHTML(1,'regular fa-folder',''+projectName, `<span class="badge">${files.length}</span>`, true, false);
  html += `<div class="panel hidden">`;
  ['tech','legal','other'].forEach(key=>{
    const label = key===OTHER_KEY? OTHER_LABEL : CATEGORY_MAP[key].label;
    html += sectionHTML(label);
    html += buckets[key].length ? buckets[key].map(fileRow).join('') : `<div class="muted">No files</div>`;
    html += `</div>`;
  });
  html += `</div>`;
  return html;
}

function customerBlock(customerName, projectsHTML, projectCount, fileCount){
  let html = rowHTML(0,'solid fa-folder',''+customerName, `<span class="badge">${projectCount} projects ¬∑ ${fileCount} files</span>`, true, false);
  html += `<div class="panel hidden tree-children">${projectsHTML}</div>`;
  return html;
}

function bindTree(){
  // ÁÇπÂáª‰∏âËßíÂàáÊç¢
  document.querySelectorAll('.row .toggle').forEach(t=>{
    const row = t.parentElement;
    const panel = row.nextElementSibling;
    if (!panel || !panel.classList.contains('panel')) return;
    t.addEventListener('click', ()=>{
      const icon = t.querySelector('i');
      const open = panel.classList.toggle('hidden') === false;
      icon.classList.toggle('fa-caret-right', !open);
      icon.classList.toggle('fa-caret-down', open);
    });
    // ÂÖÅËÆ∏ÁÇπÂáªË°åÊ†áÈ¢ò‰πüÂàáÊç¢
    row.addEventListener('click', (e)=>{ if (e.target.closest('.toggle')) return; t.click(); });
  });
}
function expandAll(){ document.querySelectorAll('.row .toggle').forEach(t=>{ const row=t.parentElement, panel=row.nextElementSibling; if(panel?.classList.contains('panel')){ panel.classList.remove('hidden'); const i=t.querySelector('i'); i.classList.remove('fa-caret-right'); i.classList.add('fa-caret-down'); }}); }
function collapseAll(){ document.querySelectorAll('.row .toggle').forEach(t=>{ const row=t.parentElement, panel=row.nextElementSibling; if(panel?.classList.contains('panel')){ panel.classList.add('hidden'); const i=t.querySelector('i'); i.classList.remove('fa-caret-down'); i.classList.add('fa-caret-right'); }}); }

/** =============== Search & Filter =============== */
function applyFilters(){
  const q = ($q.value||'').trim().toLowerCase();
  const cat = $cat.value;
  let visC=0, visP=0, visF=0;

  document.querySelectorAll('.tree-children').forEach(cPanel=>{
    const cRow = cPanel.previousElementSibling; // customer row
    let showCustomer=false;

    cPanel.querySelectorAll(':scope > .row').forEach(pRow=>{
      const pPanel = pRow.nextElementSibling;
      const pName = (pRow.textContent||'').toLowerCase();

      let matchFiles=0;
      pPanel.querySelectorAll('.file-link').forEach(a=>{
        const name = a.dataset.name||'';
        const inCat = (cat==='all') || (a.dataset.cat===cat);
        const inQ = !q || name.includes(q) || pName.includes(q) || (cRow.textContent||'').toLowerCase().includes(q);
        const keep = inCat && inQ;
        a.classList.toggle('hidden', !keep);
        if (keep) matchFiles++;
      });

      const keepProject = matchFiles>0 || (!q || pName.includes(q));
      pRow.classList.toggle('hidden', !keepProject);
      pPanel.classList.toggle('hidden', !keepProject);
      if (keepProject){ showCustomer=true; visP++; visF+=matchFiles; }
    });

    cRow.classList.toggle('hidden', !showCustomer);
    cPanel.classList.toggle('hidden', !showCustomer);
    if (showCustomer) visC++;
  });

  $stats.textContent = `Customers: ${visC}/${TOTALS.customers} ¬∑ Projects: ${visP}/${TOTALS.projects} ¬∑ Files: ${visF}/${TOTALS.files}`;
}

/** =============== Main Render =============== */
async function render(){
  if (!ACCESS_TOKEN) return;
  $root.innerHTML = `<div class="muted">Loading‚Ä¶</div>`;
  TOTALS = { customers:0, projects:0, files:0 };

  try{
    const customers = await listCustomers(CONFIG.ROOT_FOLDER_ID);
    TOTALS.customers = customers.length;

    const blocks = await Promise.all(customers.map(async (c)=>{
      const projects = await listProjects(c.id);
      let filesTotal = 0;
      TOTALS.projects += projects.length;

      const pHtml = await Promise.all(projects.map(async (p)=>{
        const files = await listFiles(p.id);
        filesTotal += files.length;
        TOTALS.files += files.length;
        return projectBlock(p.name, files);
      }));

      return customerBlock(c.name, pHtml.join(''), projects.length, filesTotal);
    }));

    const html = `<div class="tree">${blocks.join('')}</div>`;
    $root.innerHTML = html || '<p class="muted">No customers/projects found.</p>';
    $stats.textContent = `Customers: ${TOTALS.customers} ¬∑ Projects: ${TOTALS.projects} ¬∑ Files: ${TOTALS.files}`;
    bindTree();
    applyFilters();
  }catch(err){ showError(err); }
}

/* Â∞èÂ∑•ÂÖ∑ */
function debounce(fn,ms=250){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms);} }
</script>
</body>
</html>
